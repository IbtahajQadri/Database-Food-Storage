{% extends 'inventory/base.html' %}
{% block content %}
<div class="category-container">
    <h2>Manage Categories</h2>
    <a href="{% url 'category' %}?action=create"><button>Create Category</button></a>
    <a href="{% url 'category' %}?action=modify"><button>Modify Category</button></a>
    <a href="{% url 'category' %}?action=delete"><button>Delete Category</button></a>
</div>

{% if action == 'create' %}
<div style="max-width: 500px; margin: 30px auto; padding: 20px; border: 1px solid #ccc; border-radius: 8px; background-color: #f9f9f9; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
    <h3>Create New Category</h3>
    <form method="POST" action="{% url 'category' %}?action=create">
        {% csrf_token %}
        <label for="name">Name of Category:</label><br>
        <input type="text" id="name" name="name" required value="{{ form_data.name|default:'' }}"><br><br>

        <label for="unit">Units of Quantity:</label><br>
        <select id="unit" name="unit" required>
            <option value="">-- Select Unit --</option>
            {% for unit in units %}
                <option value="{{ unit }}" {% if form_data.unit == unit %}selected{% endif %}>{{ unit }}</option>
            {% endfor %}
        </select><br><br>

        <label for="ideal_quantity">Ideal Quantity:</label><br>
        <input type="number" id="ideal_quantity" name="ideal_quantity" min="0" step="any" required value="{{ form_data.ideal_quantity|default:'' }}"><br><br>

        <button type="submit">Create</button>
    </form>

    {% if success_message %}
        <p style="color:green;">{{ success_message }}</p>
    {% endif %}
    {% if error_message %}
        <p style="color:red;">{{ error_message }}</p>
    {% endif %}
</div>

{% elif action == 'modify' %}
<div style="max-width: 500px; margin: 30px auto; padding: 20px; border: 1px solid #ccc; border-radius: 8px; background-color: #f9f9f9; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
    <h3>Modify Category</h3>
    <form method="POST" action="{% url 'category' %}?action=modify">
        {% csrf_token %}
        <label for="category-modify-select">Select Category to Modify:</label><br>
        <select id="category-modify-select" name="category_id" required onchange="onCategoryChange(this)">
            <option value="">-- Select Category --</option>
            {% for category in categories %}
                <option value="{{ category.id }}" {% if selected_category and selected_category.id == category.id %}selected{% endif %}>
                    {{ category.name }}
                </option>
            {% endfor %}
        </select><br><br>

        <label for="name">Enter New Name:</label><br>
        <input type="text" id="name" name="name" required
               value="{% if form_data.name %}{{ form_data.name }}{% elif selected_category %}{{ selected_category.name }}{% endif %}"><br><br>

        <label for="unit">Enter New Units:</label><br>
        <select id="unit" name="unit" required>
            <option value="">-- Select Unit --</option>
            {% for unit in units %}
                <option value="{{ unit }}"
                    {% if form_data.unit == unit %}
                        selected
                    {% elif selected_category and selected_category.unit == unit %}
                        selected
                    {% endif %}
                >
                    {{ unit }}
                </option>
            {% endfor %}
        </select><br><br>

        <label for="ideal_quantity">Enter New Ideal Quantity:</label><br>
        <input type="number" id="ideal_quantity" name="ideal_quantity" min="0" step="any" required
               value="{% if form_data.ideal_quantity %}{{ form_data.ideal_quantity }}{% elif selected_category %}{{ selected_category.ideal_quantity }}{% endif %}"><br><br>

        <button type="submit">Modify</button>
    </form>

    {% if success_message %}
        <p style="color:green;">{{ success_message }}</p>
    {% endif %}
    {% if error_message %}
        <p style="color:red;">{{ error_message }}</p>
    {% endif %}
</div>


{% elif action == 'delete' %}
<div style="max-width: 500px; margin: 30px auto; padding: 20px; border: 1px solid #ccc; border-radius: 8px; background-color: #f9f9f9; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
    <h3>Delete Category</h3>
    <form method="POST" action="{% url 'category' %}?action=delete" onsubmit="return confirmDelete(this)">
        {% csrf_token %}

        <label for="category-select">Select Category to Delete:</label><br>
        <select id="category-select" name="category_id" required>
            <option value="">-- Select Category --</option>
            {% for category in categories %}
                <option value="{{ category.id }}" {% if form_data.category_id == category.id|stringformat:"s" %}selected{% endif %}>
                    {{ category.name }}
                </option>
            {% endfor %}
        </select><br><br>

        <!-- Placeholder to show selected category details -->
        <div id="category-details" style="margin-bottom: 15px; padding: 10px; border: 1px solid #ddd; border-radius: 6px; background-color: #fff; display: none;">
            <strong>Category Details:</strong>
            <p><b>Name:</b> <span id="detail-name"></span></p>
            <p><b>Unit:</b> <span id="detail-unit"></span></p>
            <p><b>Ideal Quantity:</b> <span id="detail-ideal_quantity"></span></p>
        </div>

        <!-- Hidden field to be filled by JS -->
        <input type="hidden" name="confirm_delete" value="0">

        <button type="submit" 
            style="background-color: #dc3545; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer;">
            Delete
        </button>
    </form>

    {% if success_message %}
        <p style="color:green;">{{ success_message }}</p>
    {% endif %}
    {% if error_message %}
        <p style="color:red;">{{ error_message }}</p>
    {% endif %}
</div>
<script>
// Data about categories as a JS object for quick lookup
const categoriesData = {
    {% for category in categories %}
    "{{ category.id }}": {
        "name": "{{ category.name|escapejs }}",
        "unit": "{{ category.unit|escapejs }}",
        "ideal_quantity": "{{ category.ideal_quantity }}"
    }{% if not forloop.last %},{% endif %}
    {% endfor %}
};
</script>
{% endif %}

<script>
document.getElementById('category-select').addEventListener('change', function() {
    const selectedId = this.value;
    const detailsDiv = document.getElementById('category-details');
    const nameSpan = document.getElementById('detail-name');
    const unitSpan = document.getElementById('detail-unit');
    const idealQuantitySpan = document.getElementById('detail-ideal_quantity');

    if (selectedId && categoriesData[selectedId]) {
        nameSpan.textContent = categoriesData[selectedId].name;
        unitSpan.textContent = categoriesData[selectedId].unit;
        idealQuantitySpan.textContent = categoriesData[selectedId].ideal_quantity;
        detailsDiv.style.display = 'block';
    } else {
        // No category selected, hide details
        detailsDiv.style.display = 'none';
        nameSpan.textContent = '';
        unitSpan.textContent = '';
        idealQuantitySpan.textContent = '';
    }
});

// Also trigger the change event on page load to show data if selected
window.addEventListener('load', function() {
    const event = new Event('change');
    document.getElementById('category-select').dispatchEvent(event);
});

function confirmDelete(form) {
    if (confirm("Are you sure you want to delete this category?")) {
        form.confirm_delete.value = "1";
        return true;
    } else {
        return false;
    }
}

    function onCategoryChange(select) {
        const categoryId = select.value;
        if (categoryId) {
            window.location.href = "{% url 'category' %}?action=modify&category_id=" + categoryId;
        }
    }
</script>
{% endblock %}